doctype html
html(lang="zh-Hant")
  head
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    title Azure Computer Vision Analyzer
    
    link(rel='icon', href='data:;base64,iVBORw0KGgo=')
    link(rel='stylesheet', href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css', integrity='sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3', crossorigin='anonymous')
    link(rel='stylesheet', href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css')
    
    style.
      .vision-container {
        max-width: 1200px;
        margin: 30px auto;
        padding: 20px;
      }
      .upload-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 30px;
        margin-bottom: 30px;
      }
      .upload-box {
        border: 2px dashed #007bff;
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
      }
      .upload-box:hover {
        border-color: #0056b3;
        background: #f0f8ff;
      }
      .upload-box input[type="file"] {
        display: none;
      }
      .btn-group-custom {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .btn-group-custom button {
        flex: 1;
      }
      #imagePreview {
        margin-top: 20px;
        text-align: center;
      }
      #analysisResults {
        display: none;
        margin-top: 30px;
      }
      #loadingSpinner {
        display: none;
        text-align: center;
        margin: 20px 0;
      }
      .result-section {
        margin-bottom: 20px;
      }
      .recent-analyses {
        margin-top: 30px;
      }
      .badge {
        font-size: 0.85em;
        padding: 0.4em 0.6em;
      }
      pre {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #007bff;
      }
  
  body
    .container
      include partials/navbar
      
      .vision-container
        h1.text-center.mb-4
          i.fas.fa-eye.me-2
          | Azure Computer Vision Analyzer
        
        p.text-center.text-muted.mb-4
          | Upload an image to extract text (OCR) and analyze content using Azure AI
        
        .upload-section
          h4.mb-3
            i.fas.fa-cloud-upload-alt.me-2
            | Upload Image
          
          .upload-box(onclick="document.getElementById('imageInput').click()")
            i.fas.fa-images.fa-3x.text-primary.mb-3
            h5 Click to select an image
            p.text-muted Supports JPEG, PNG, GIF, BMP (Max 5MB)
            input#imageInput(type="file" accept="image/*")
          
          #imagePreview
          
          #uploadError.alert.alert-danger.mt-3(style="display: none;")
          
          .btn-group-custom
            button#analyzeBtn.btn.btn-primary.btn-lg(type="button")
              i.fas.fa-magic.me-2
              | Complete Analysis
            button#ocrOnlyBtn.btn.btn-outline-primary.btn-lg(type="button")
              i.fas.fa-font.me-2
              | OCR Only
        
        #loadingSpinner
          .spinner-border.text-primary(role="status")
            span.visually-hidden Loading...
          p.mt-2 Analyzing image, please wait...
        
        #analysisResults
        
        .recent-analyses
          h4.mb-3
            i.fas.fa-history.me-2
            | Recent Analyses
          #recentAnalyses
            p.text-muted Loading...
    
    // Scripts
    script(src="https://code.jquery.com/jquery-3.6.0.min.js")
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js")
    
    // Firebase initialization (ES6 module)
    script(type='module')
      | import { initialize } from '/firebase-client.js';
      | 
      | // Initialize Firebase and expose to global scope
      | window.firebaseReady = initialize()
      |   .then(({ app, auth }) => {
      |     console.log('‚úÖ Firebase initialized successfully');
      |     window.firebaseAuth = auth;
      |     window.firebaseApp = app;
      |     
      |     // Listen to authentication state changes
      |     auth.onAuthStateChanged(user => {
      |       if (user) {
      |         console.log('üë§ User authenticated:', user.uid);
      |       } else {
      |         console.log('üë§ No user authenticated');
      |       }
      |     });
      |     
      |     return auth;
      |   })
      |   .catch(err => {
      |     console.warn('‚ö†Ô∏è Firebase initialization failed:', err);
      |     console.warn('Will use fallback user ID from localStorage');
      |     return null;
      |   });
    
    // Vision Uploader (ensure it loads after Firebase initialization)
    script(src="/js/visionUploader.js" defer)
